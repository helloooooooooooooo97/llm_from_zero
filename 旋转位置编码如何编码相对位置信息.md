
# 旋转位置编码 (RoPE) 核心原理


## 核心数学基础：复数与旋转

RoPE 将词嵌入向量 $E$ 的相邻两个维度 $\begin{pmatrix} E_{2m} \\ E_{2m+1} \end{pmatrix}$ 视为一个复数 $z = E_{2m} + i E_{2m+1}$。

位置 $i$ 的编码操作是一个 旋转操作 $R_i(\cdot)$，它将向量旋转 $i \cdot \theta$ 的角度，其中 $\theta$ 是一个预设的频率。

## 目标：点积只依赖于相对距离

RoPE 的设计目标是让施加了位置信息的 $Q_i'$ 和 $K_j'$ 的点积，满足以下特性（这是相对位置编码的理想特性）：

$$Q_i' \cdot K_j' = f(E_i, E_j, j-i)$$

其中，$f$ 是一个只依赖于内容 $E_i, E_j$ 和 相对距离 $j-i$ 的函数。

## 实现原理：相位的抵消

RoPE 利用旋转矩阵 $R_i$ 和 $R_j$ 的性质，在点积中实现了绝对位置信息的抵消：

1.  施加位置信息：
    $$Q_i' = R_i Q_i \quad \text{和} \quad K_j' = R_j K_j$$
2.  计算点积：
    $$Q_i' \cdot K_j' = (R_i Q_i) \cdot (R_j K_j)$$
    由于旋转矩阵是正交的，并且满足 $R_i^T = R_i^{-1}$，可以证明这个点积等于：
    $$Q_i' \cdot K_j' = Q_i \cdot (R_i^T R_j) K_j = Q_i \cdot (R_j R_i^{-1}) K_j$$
3.  相对距离浮现：
    根据旋转矩阵的性质，两个旋转的组合 $R_j R_i^{-1}$ 恰好等于只依赖于相对距离的旋转 $R_{j-i}$：
    $$R_j R_i^{-1} = R_{j-i}$$
    因此，点积变为：
    $$Q_i' \cdot K_j' = Q_i \cdot R_{j-i} K_j$$

这个最终结果 $Q_i \cdot R_{j-i} K_j$ 明确地显示，注意力分数完全由 Token 内容 $Q_i$ 和 $K_j$，以及它们之间的 相对距离 $(j-i)$ 所决定。绝对位置 $i$ 和 $j$ 的信息在点积中被完全抵消，从而实现了严格的平移不变性。