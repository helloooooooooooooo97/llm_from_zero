# 旋转位置编码 (RoPE) 的相位相消证明：实现纯净相对性

本文档详细证明了旋转位置编码（RoPE）中，旋转矩阵如何通过相位相消机制，实现绝对位置信息的抵消，从而使自注意力分数仅依赖于相对距离。

# 绝对位置的相位相消

我们利用上述性质来证明 RoPE 中最关键的定理：**两个旋转矩阵的组合只依赖于相对距离。**

## 定理：相对旋转关系

对于位置 $i$ 和 $j$ 的旋转矩阵 $R_i$ 和 $R_j$，它们的组合（相乘）关系只取决于相对位置差 $j-i$：

$$R_j R_i^{-1} = R_{j-i}$$

## 证明

### 步骤 1：利用逆矩阵与负角度的关系

先详细展开说明如下：

首先，旋转矩阵的逆等于它的转置（由正交性质可知）：
$$
R_i^{-1} = R_i^T
$$

对二维旋转矩阵 $R(\alpha)$，转置后变为：
$$
R(\alpha)^T = \begin{pmatrix}
\cos\alpha & \sin\alpha \\
-\sin\alpha & \cos\alpha
\end{pmatrix}
$$

事实上，这个矩阵正好等于旋转 $-\alpha$ 的矩阵：
$$
R(-\alpha) = \begin{pmatrix}
\cos(-\alpha) & -\sin(-\alpha) \\
\sin(-\alpha) & \cos(-\alpha)
\end{pmatrix}
= \begin{pmatrix}
\cos\alpha & \sin\alpha \\
-\sin\alpha & \cos\alpha
\end{pmatrix}
$$

上面等号成立的原因是利用了三角函数的奇偶性：
- $\cos(-x) = \cos(x)$
- $\sin(-x) = -\sin(x)$

因此，对于 $R_i = R(i \cdot \theta)$，我们有
$$
R_i^{-1} = R(i \cdot \theta)^{-1} = R(i \cdot \theta)^T = R(-i \cdot \theta)
$$

即，旋转矩阵的逆相当于将角度取反，也就是对应**负角度**的旋转。

### 步骤 2：应用复合性质

将此关系代入待证等式，并应用性质 2 (角度叠加)：

$$\begin{aligned}
R_j R_i^{-1} &= R(j \cdot \theta) R(-i \cdot \theta) \\
&= R(j \cdot \theta + (-i \cdot \theta)) \\
&= R((j-i) \cdot \theta) \\
&= R_{j-i}
\end{aligned}$$

**证毕。**

# 在自注意力点积中的应用

现在我们证明，这种相对旋转关系如何直接体现在 Query 和 Key 的点积中，从而消除绝对位置的依赖。

## 定理：相对点积公式

对于施加了位置编码的 Query 和 Key 向量 $Q_i'$ 和 $K_j'$：

$$Q_i' = R_i Q_i, \quad K_j' = R_j K_j$$

它们的点积计算结果满足：

$$Q_i' \cdot K_j' = Q_i \cdot (R_{j-i} K_j)$$

**证明：**

$$\begin{aligned}
Q_i' \cdot K_j' &= (R_i Q_i) \cdot (R_j K_j) \\
&= (R_i Q_i)^T (R_j K_j) & \quad (\text{点积的矩阵形式}) \\
&= Q_i^T R_i^T R_j K_j & \quad (\text{转置的性质}) \\
&= Q_i^T (R_i^{-1} R_j) K_j & \quad (\text{由性质 1，} R_i^T = R_i^{-1}) \\
&= Q_i^T (R_j R_i^{-1}) K_j & \quad (\text{矩阵乘法结合律}) \\
&= Q_i^T R_{j-i} K_j & \quad (\text{由核心证明定理，相位相消}) \\
&= Q_i \cdot (R_{j-i} K_j) & \quad (\text{转换回向量点积形式})
\end{aligned}$$

## 关键结论：严格的平移不变性

最终的点积公式 $Q_i \cdot R_{j-i} K_j$ 表明：
1.  **绝对位置 $i$ 和 $j$ 的信息被完全抵消。**
2.  注意力分数仅由 **内容向量 $Q_i$ 和 $K_j$**，以及 **相对距离 $(j-i)$** 决定。
3.  这保证了 Transformer 的自注意力机制具有**严格的平移不变性** (Translational Invariance)，从而避免了传统 APE 中绝对位置信息对相对关系的“噪声”干扰。

# 多维情况的推广

在 $d_{model}$ 维空间中，RoPE 的位置旋转矩阵 $R_i$ 具体实现为**块对角矩阵**，其结构如下：

- $R_i$ 是一个 $d_{model} \times d_{model}$ 的方阵，由 $d_{model}/2$ 个 $2 \times 2$ 旋转子矩阵沿对角线堆叠组成。
- 第 $m$ 个 $2 \times 2$ 块 $R(i \cdot \theta_m)$ 作用于嵌入向量的第 $2m$、$2m+1$ 维，$\theta_m$ 是与该维度关联的固定频率。

具体表达式为：

$$
R_i = \operatorname{BlockDiag}(R(i \cdot \theta_0),\ R(i \cdot \theta_1),\ \dots,\ R(i \cdot \theta_{d_{model}/2-1}))
$$

每个 $2 \times 2$ 旋转块的形式为：
$$
R(i \cdot \theta_m) = 
\begin{bmatrix}
\cos(i\theta_m) & -\sin(i\theta_m) \\
\sin(i\theta_m) & \cos(i\theta_m)
\end{bmatrix}
$$

由于**块对角矩阵乘法等价于每个 $2\times 2$ 块分别相乘**，前述关于二维旋转矩阵正交性、逆、以及相位相消的所有证明，都会独立作用于每一对维度（即每个块）。因此对于任意两个绝对位置 $i, j$，依然有 $R_j R_i^{-1} = R_{j-i}$，其中每个块分量都成立：

$$
R_j R_i^{-1} = \operatorname{BlockDiag}(R(j\theta_0)R(-i\theta_0),\, \dots) = \operatorname{BlockDiag}(R((j-i)\theta_0),\, \dots) = R_{j-i}
$$

# 结论
RoPE 在高维词嵌入空间中，能在每个子空间（对应每个频率）上独立实现绝对位置的相位相消。本质上，RoPE 精确地把绝对位置信息转化为 $2 \times 2$ 子空间上的旋转，保证了整体相对位置编码的正确性和平移不变性。
