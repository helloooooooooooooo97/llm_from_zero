# 绝对位置编码点积中相对位置信息的证明

要严格证明绝对位置编码的点积只依赖于相对位置 $i-j$，数学上其实涉及高维向量的积分和近似，但这里可以展示核心思想和基本近似过程。

下面证明，对于每一对维度上的位置编码分量，它们的点积（两个维度上的和）只依赖于相对位置 $i-j$。

## 核心证明思路

设 $i$ 和 $j$ 为两个位置，$PE_i$ 和 $PE_j$ 是对应的位置编码向量。位置编码 $PE$ 的维度 $d_{model}$ 是偶数，我们考虑 $PE_i \cdot PE_j$ 的计算。

1. 定义角参数

对于每一对维度 $2k$ 和 $2k+1$（$k = 0, 1, \dots, d_{model}/2 - 1$），定义公用的频率因子
$$\omega_k = 1 / 10000^{2k/d_{model}}$$

第 $i$ 个位置的这对分量为：
$$PE_i^{(k)} = \begin{pmatrix} \sin(i \cdot \omega_k) \\ \cos(i \cdot \omega_k) \end{pmatrix}$$
第 $j$ 个位置对应为：
$$PE_j^{(k)} = \begin{pmatrix} \sin(j \cdot \omega_k) \\ \cos(j \cdot \omega_k) \end{pmatrix}$$

2. 计算一对维度上的点积

这对维度上的点积 $C_k$ 为
$$C_k = PE_i^{(k)} \cdot PE_j^{(k)}$$
$$C_k = \sin(i \cdot \omega_k) \cdot \sin(j \cdot \omega_k) + \cos(i \cdot \omega_k) \cdot \cos(j \cdot \omega_k)$$

3. 应用三角函数角和公式

利用三角恒等式
$$\cos(\alpha - \beta) = \cos\alpha \cos\beta + \sin\alpha \sin\beta$$
令 $\alpha = j \cdot \omega_k$，$\beta = i \cdot \omega_k$:
$$C_k = \cos(j \cdot \omega_k - i \cdot \omega_k) = \cos((j - i) \cdot \omega_k)$$

结论：在每一对维度上，点积 $C_k$ 只依赖于相对位置差 $|j-i|$（因为 $\cos$ 是偶函数）。

4. 完整的点积

完整的点积 $PE_i \cdot PE_j$ 是所有维度对的总和：
$$PE_i \cdot PE_j = \sum_{k=0}^{d_{model}/2 - 1} C_k = \sum_{k=0}^{d_{model}/2 - 1} \cos((j - i) \cdot \omega_k)$$

## 总结和近似的理解

$$\mathbf{PE}_i \cdot \mathbf{PE}_j = \sum_{k=0}^{d_{model}/2 - 1} \cos\left( (j-i) \cdot \frac{1}{10000^{2k/d_{model}}} \right)$$

- 证明 $PE_i \cdot PE_j$ 是关于相对距离 $j-i$ 的函数 $f(j-i)$，这就是它隐式包含相对位置信息的数学基础。
- “$\cos(i-j)$ 组合”的意思是不同频率 $\omega_k$ 下 $\cos$ 的值相加。
- 当 $d_{model}$ 很大时，可以将离散求和近似为积分，这个积分结果可视为近似只依赖 $j-i$ 的平移不变函数。在实践中，$d_{model}=512$ 或 $1024$ 已经让这种关系保持得很好。

## 为什么 $PE_i \cdot PE_j$ 能当作相对位置偏置

在注意力机制中，点积操作是一种相似性度量。当 $PE_i \cdot PE_j$ 很大（位置编码相似）时，会提升注意力分数。

因为：
1. 如果 $|i-j|$ 较小（即 $i$ 和 $j$ 靠近），$(j-i) \cdot \omega_k$ 在所有 $\omega_k$ 上都接近 0，$\cos(\dots)$ 接近 1，最终 $PE_i \cdot PE_j$ 很大。
2. 如果 $|i-j|$ 较大（即 $i$ 和 $j$ 距离远），$(j-i) \cdot \omega_k$ 的值在 $(0, \pi)$ 区间分布，求和后会部分抵消，$PE_i \cdot PE_j$ 变小。

因此，$PE_i \cdot PE_j$ 作为“距离衰减”的偏置项，天然为近距离 Token 提供更高注意力分数，这与相对位置编码的目标一致。

---

这个证明展示了绝对位置编码设计的巧妙性。如果有兴趣，可以进一步讨论 RoPE（旋转位置编码）如何利用类似的三角性质更彻底解决相对位置问题。